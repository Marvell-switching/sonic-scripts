From 033b571d1ee4091ccfc3ccbb43608dd01af98738 Mon Sep 17 00:00:00 2001
From: Yan Markman <ymarkman@marvell.com>
Date: Mon, 29 Sep 2025 14:26:28 +0300
Subject: [PATCH 1/2] sonic-platform-marvell: rules for trixie

Signed-off-by: Yan Markman <ymarkman@marvell.com>
---
 debian/rules | 59 ++++++++++++++++++++--------------------------------
 1 file changed, 22 insertions(+), 37 deletions(-)

diff --git a/debian/rules b/debian/rules
index 21a5bbc..a109709 100755
--- a/debian/rules
+++ b/debian/rules
@@ -20,23 +20,31 @@ PRESTERA_MODULE_PREFIX := mrvl-prestera/drivers/generic/
 PRESTERA_MODULE_SRC := cpssEnabler/linuxNoKernelModule/drivers/
 
 %:
-	dh $@ --with systemd,python3 --buildsystem=pybuild
+	dh $@ --with python3 --buildsystem=pybuild
 
-clean:
-	dh_testdir
-	dh_testroot
-	dh_clean
+override_dh_auto_clean:
 	(for mod in $(MODULE_DIRS); do \
+		$(MAKE) clean -C $(KERNEL_SRC)/build M=$(MOD_SRC_DIR)/$${mod}/modules; \
+		if [ -f $(MOD_SRC_DIR)/$${mod}/setup.py ]; then \
+			PYBUILD_NAME=$${mod} pybuild --clean -d $${mod}; \
+		fi; \
 		cd $(MOD_SRC_DIR)/$${mod}; \
-		rm -rf build/; \
-		rm -rf mrvl-modules/; \
+		rm -rf $(MRVL_MODULE_DIR)/; \
 		rm -rf *.egg-info/; \
 		rm -f *.whl; \
 		cd $(MOD_SRC_DIR)/; \
 	done)
+	dh_clean
 
-build:
+override_dh_auto_configure:
 	(for mod in $(MODULE_DIRS); do \
+		if [ -f $(MOD_SRC_DIR)/$${mod}/setup.py ]; then \
+			PYBUILD_NAME=$${mod} pybuild --configure -d $${mod}; \
+		fi; \
+	done)
+
+override_dh_auto_build:
+	(set -e; for mod in $(MODULE_DIRS); do \
 		mkdir -p $(MOD_SRC_DIR)/$${mod}/$(MRVL_MODULE_DIR); \
 		cp -r $(MOD_SRC_DIR)/../$(PRESTERA_MODULE_PREFIX)/* $(MOD_SRC_DIR)/$${mod}/$(MRVL_MODULE_DIR)/; \
 		cd $(MOD_SRC_DIR)/$${mod}/$(MRVL_MODULE_DIR)/$(PRESTERA_MODULE_SRC); \
@@ -63,18 +71,14 @@ build:
 	done)
 
 
-binary: binary-arch binary-indep
-	# Nothing to do
-
-binary-arch:
-	# Nothing to do
+override_dh_auto_test:
+	# No tests to run
 
-binary-indep:
-	dh_testdir
-	dh_installdirs
+override_dh_usrlocal:
+	# debian/sonic-platform-<>-<>/usr/local/bin/* are already done
 
-	# Custom package commands
-	(for mod in $(MODULE_DIRS); do \
+override_dh_auto_install:
+	(set -e; for mod in $(MODULE_DIRS); do \
 		if [ $$mod = "rd98dx35xx_cn9131" ]; then \
 			pkg="rd98dx35xx-cn9131"; \
 		else \
@@ -94,22 +98,3 @@ binary-indep:
 		python3 setup.py install --root=$(MOD_SRC_DIR)/debian/sonic-platform-$${pkg} --install-layout=deb; \
 		cd $(MOD_SRC_DIR); \
 	done)
-
-	# Resuming debhelper scripts
-	dh_testroot
-	dh_install
-	dh_installchangelogs
-	dh_installdocs
-	dh_systemd_enable
-	dh_installinit
-	dh_systemd_start
-	dh_link
-	dh_fixperms
-	dh_compress
-	dh_strip
-	dh_installdeb
-	dh_gencontrol
-	dh_md5sums
-	dh_builddeb
-
-.PHONY: build binary binary-arch binary-indep clean
-- 
2.34.1

