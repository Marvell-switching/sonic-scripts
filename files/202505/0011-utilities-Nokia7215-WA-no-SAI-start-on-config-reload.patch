From 8ba7575672ff1ae0ed2a9a24525e12be7ee5066b Mon Sep 17 00:00:00 2001
From: Yan Markman <ymarkman@marvell.com>
Date: Sat, 5 Jul 2025 21:40:59 +0300
Subject: [PATCH] [utilities] Nokia7215:WA: no SAI start on config-reload

https://github.com/sonic-net/sonic-buildimage/issues/22994
Config reload command doesn't start SAI on branch master/202505 on board Nokia-7215/AC3
Same/similar is for load minigraph command

Current WORKAROUND:
add "restart swss" at the end of "reload" command handling in file

[src/sonic-utilities/]config/main.py
On board: /usr/local/lib/python3.11/dist-packages/config/main.py

======================================================================
Description of the bug

Marvell SAI starting is never achieved on command "config reload -y".
Last worked - branch 202411, stopped to work properly on branch master and branch 202505.
Platform: marvell-prestera, ARCH=armhf, board Nokia-7215(AC3)

Problem suspect -- orchestration synchronization on STOP service.

Observations are:
- Both swss and syncd containers are Up/Running but SAI is not achieved
    not started (according to syslog).
- apply "systemctl restart swss" fixes the problem
- apply "systemctl restart sonic.target"
    (which is last part of "config reload" implementation) is always FAIL
- Manual Stop sequence (with sleeps) emulating "stop sonic.target"
    followed by "start sonic.target" is OK!
- The "config reload" has also DB-config and migration processing which
    also cause problem

Signed-off-by: Yan Markman <ymarkman@marvell.com>

diff --git a/config/main.py b/config/main.py
index 0a5b1e32..e3b2c44e 100644
--- a/config/main.py
+++ b/config/main.py
@@ -1018,6 +1018,18 @@ def wait_service_restart_finish(service, last_timestamp, timeout=30):
 
     log.log_warning("Service: {} does not restart in {} seconds, stop waiting".format(service, timeout))
 
+def get_device_name():
+    """
+    Reads /host/machine.conf and returns the value of 'onie_platform'
+    """
+    machine_conf = "/host/machine.conf"
+    try:
+        with open(machine_conf) as f:
+            for line in f:
+                if line.startswith("onie_platform="):
+                    return line.strip().split("=", 1)[1]
+    except Exception as e:
+        return None
 
 def _restart_services():
     last_interface_config_timestamp = get_service_finish_timestamp('interfaces-config')
@@ -1043,6 +1055,14 @@ def _restart_services():
     click.echo("Reloading Monit configuration ...")
     clicommon.run_command(['sudo', 'monit', 'reload'])
 
+    device_name = get_device_name()
+    if device_name == "armhf-nokia_ixs7215_52x-r0":
+        click.echo("ARMHF/Nokia-7215: WA force restart swss and syncd")
+        time.sleep(10)
+        clicommon.run_command(['sudo', 'systemctl', 'stop', 'swss'])
+        clicommon.run_command(['sudo', 'systemctl', 'stop', 'syncd'])
+        clicommon.run_command(['sudo', 'systemctl', 'restart', 'swss'])
+
 def _per_namespace_swss_ready(service_name):
     out, _ = clicommon.run_command(['systemctl', 'show', str(service_name), '--property', 'ActiveState', '--value'], return_cmd=True)
     if out.strip() != "active":
-- 
2.25.1

