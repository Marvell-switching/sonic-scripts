From 29ccf193db163cc5dbacd42ccf0cc265ef86d559 Mon Sep 17 00:00:00 2001
From: Yan Markman <ymarkman@marvell.com>
Date: Sat, 6 Dec 2025 21:44:17 +0200
Subject: [PATCH 1/1] utilities: config-reload with swss and sync restart

Issue
https://github.com/sonic-net/sonic-buildimage/issues/24766

Signed-off-by: Yan Markman <ymarkman@marvell.com>
---
 config/main.py | 24 ++++++++++++++++++++++++
 1 file changed, 24 insertions(+)

diff --git a/config/main.py b/config/main.py
index 5695b800..315fd040 100644
--- a/config/main.py
+++ b/config/main.py
@@ -1040,6 +1040,19 @@ def wait_service_restart_finish(service, last_timestamp, timeout=30):
 
     log.log_warning("Service: {} does not restart in {} seconds, stop waiting".format(service, timeout))
 
+def get_device_name():
+    """
+    Reads /host/machine.conf and returns the value of 'onie_platform'
+    """
+    machine_conf = "/host/machine.conf"
+    try:
+        with open(machine_conf) as f:
+            for line in f:
+                if line.startswith("onie_platform="):
+                    return line.strip().split("=", 1)[1]
+    except Exception as e:
+        return None
+
 def get_mgmt_interface():
     """
     Parse /etc/sonic/config_db.json to find the management interface name (e.g., eth0).
@@ -1104,6 +1117,17 @@ def _restart_services():
     click.echo("Reloading Monit configuration ...")
     clicommon.run_command(['sudo', 'monit', 'reload'])
 
+    device_name = get_device_name()
+    if device_name == "armhf-nokia_ixs7215_52x-r0":
+        click.echo("ARMHF/Nokia-7215: force restart swss and syncd")
+        time.sleep(15)
+        clicommon.run_command(['sudo', 'systemctl', 'stop', 'swss'])
+        clicommon.run_command(['sudo', 'systemctl', 'stop', 'syncd'])
+        time.sleep(1)
+        clicommon.run_command(['sudo', 'systemctl', 'reset-failed', 'swss'])
+        clicommon.run_command(['sudo', 'systemctl', 'reset-failed', 'syncd'])
+        clicommon.run_command(['sudo', 'systemctl', 'restart', 'swss'])
+
     reset_mgmt_interface_if_usb_not_running()
 
 def _per_namespace_swss_ready(service_name):
-- 
2.34.1

